# randomized checks use index numbers (generated at runtime) to look up info in
# a table of {treasure id, treasure param, collect mode, destination player}.
# bit 7 of a treasure id (for creating interaction 60s or calling giveTreasure)
# indicates that treasure info should be overwritten by an indexed lookup when
# set. bits 0-6 of the id are treated as the low 7 bits of the index; the subid
# is used as the higher bits if present.

common:
  # b and c are used to index the table.
  # returns the address of the entry in hl.
  # returns c if the check was looked up.
  00/lookupCheck: |
      xor a # reset carry
      bit 7,b
      ret z
      push de
      ld e,06
      ld hl,lookupCheck_body
      call interBankCall
      pop de
      scf
      ret

  06/lookupCheck_body: |
      ld hl,checkIndexTable
      call convertIdsToIndex
      add hl,bc
      add hl,bc
      add hl,bc
      add hl,bc
      ret

  # converts b = id, c = subid to bc = index.
  06/convertIdsToIndex: |
      ld a,b
      ld b,c
      ld c,a
      sra b
      ret c
      res 7,c
      ret

  # b and c are used to index the table.
  # returns b and c as the final id and param of the check.
  # returns nz if the check was looked up.
  00/getCheckIdAndParam: |
      push de
      ld e,06
      ld hl,getCheckIdAndParam_body
      call interBankCall
      ld a,e
      and a
      pop de
      ret

  06/getCheckIdAndParam_body: |
      push bc
      call lookupCheck
      pop bc
      ld e,00
      ret nc
      inc e
      ld b,(hl)
      inc hl
      ld c,(hl)
      ret
